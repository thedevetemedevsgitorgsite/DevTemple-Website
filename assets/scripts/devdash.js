import{createClient}from"https://esm.sh/@supabase/supabase-js@2";const sections={user:document.getElementById("user-section"),pen:document.getElementById("pen-section"),sales:document.getElementById("sales-section"),chart:document.getElementById("chart-section"),posts:document.getElementById("posts-section"),notify:document.getElementById("notify-section")};let authBio="creator",authImg="/assets/images/default.png",authName="creator",authSkill="creator",portfolioUrl=" ",authFname="creator",authStatus="pending";function showSection(e){Object.values(sections).forEach((e=>e.classList.add("hidden"))),sections[e]&&sections[e].classList.remove("hidden")}document.querySelector(".top-btn.user").onclick=()=>showSection("user"),document.querySelector(".top-btn.pen").onclick=()=>showSection("pen"),document.querySelector(".top-btn.sales").onclick=()=>showSection("sales"),document.querySelector(".top-btn.chart").onclick=()=>showSection("chart"),document.querySelector(".top-btn.notify").onclick=()=>showSection("notify");const{url:url,key:key}={url:td,key:tc};export const supabase=createClient(url,key);async function getUser(){const{data:e,error:t}=await supabase.auth.getUser();return t?(console.error("Auth error:",t),null):e?.user||null}async function signOut(){await supabase.auth.signOut(),window.location.href="/signup.html"}async function loadProfile(){const e=await getUser();if(!e)return void(window.location.href="/signup.html");document.querySelector(".user .email").textContent=e.email,document.querySelector(".user .uid").textContent=e.id;const t=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".join-date").textContent=t;const r=new Date(e.last_sign_in_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".last-login").textContent=r;const{data:a}=await supabase.from("profiles").select("*").eq("id",e.id).single();a&&(document.querySelector("#account-status").textContent=a.status,document.querySelector(".status").style.color="pending"===document.querySelector("#account-status").textContent?"#960":"#096",document.getElementById("userName").value=a.username||"",document.getElementById("fullName").value=a.full_name||"",document.getElementById("email").value=e.email,document.getElementById("phone").value=a.phone||"",document.getElementById("bio").value=a.bio||"",document.getElementById("skill").value=a.skills||"",document.getElementById("experience").value=a.experience_level||"",document.getElementById("portfolio").value=a.portfolio_url||"",document.querySelector(".user.img").src=a.photo_url||"/assets/images/default.png",document.getElementById("profileName").textContent=a.full_name||a.username||"User",document.getElementById("profileSkill").textContent=a.skills||"No skill set",document.getElementById("profileName").innerHTML+=` <sup style="font-size: 0.6em;-webkit-text-stroke: 0.2px #0f9;">${"verified"===a.status?"<i class='fas fa-check-circle' style='color:#1DA1F2;'></i>":""}</sup>`,authBio=a.bio||"",authImg=a.photo_url||"/assets/images/default.png",authName=a.username||"",authSkill=a.skills||"",authStatus=a.status||"",authFname=a.full_name||"",portfolioUrl=a.portfolio_url||"",updateBioCharCount()),await loadProfileStats()}function updateBioCharCount(){const e=document.getElementById("bio"),t=document.getElementById("bioCharCount");e&&t&&(t.textContent=e.value.length,e.addEventListener("input",(()=>{t.textContent=e.value.length})))}async function loadProfileStats(){const e=await getUser();if(!e)return;const{data:t}=await supabase.from("posts").select("sales, price").eq("user_id",e.id);if(t){const e=t.length,r=t.reduce(((e,t)=>e+(t.sales||0)),0),a=t.reduce(((e,t)=>e+(t.price||0)*(t.sales||0)),0);document.getElementById("statUploads").textContent=e,document.getElementById("statSales").textContent=r,document.getElementById("statEarnings").onclick=()=>{cAlert(`‚Ç¶${fn(a||0)}`,"success","Total earnings")}}}document.getElementById("logoutBtn").onclick=signOut;const zipInput=document.getElementById("zipInput"),filename=document.querySelector(".file-name");zipInput&&(zipInput.onchange=()=>{filename&&(filename.textContent=zipInput.files[0]?.name||"")});const publisherForm=document.getElementById("publisherForm");async function initStar(e){try{const{count:t,error:r}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(r)throw r;return t||0}catch(e){return console.error("Star init failed:",e),0}}async function deletePost(e){if(confirm(`Delete "${e.name}"? This cannot be undone.`))try{const{error:t}=await supabase.from("stars").delete().eq("post_id",e.id);if(t)return console.error("SDB delete error:",t),void cAlert("‚ùåFailed to delete related stars.","warning","Error");if(e.file_path){const{error:t}=await supabase.storage.from("uploads").remove([e.file_path]);if(t)return console.error("Storage delete error:",t),void cAlert("‚ùåFailed to delete file from storage.","warning","Failed")}const{error:r}=await supabase.from("posts").delete().eq("id",e.id);if(r)return console.error("DB delete error:",r),void cAlert("‚ùåFailed to delete post from Database.","warning","Failed");cAlert("Post deleted!","success","Deleted"),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart()}catch(e){console.error("Unexpected error:",e),cAlert("‚ùåAn unexpected error occurred.","warning","Error")}}async function loadPosts(){try{const e=await getUser();if(!e)return void console.warn("No logged-in user found.");const{data:t,error:r}=await supabase.from("posts").select("id, name, description, price, cover, auth_bio, auth_img, auth_name, star, sales, auth_skill, portfolio_url, auth_fname, auth_status, created_at").eq("user_id",e.id).order("created_at",{ascending:!1});if(r)throw r;const a=document.querySelector(".product-grid");if(!a)return;if(a.innerHTML="",!t||0===t.length)return void(a.innerHTML='<p class="empty-msg">You haven\'t uploaded any posts yet.</p>');t.forEach((e=>{const t=document.createElement("div");t.className="card",t.innerHTML=`\n        <div class="product-img" style="background-image: url(${e.cover||"/assets/images/index.png"});">\n          <h3 class="delete-btn"><i class="fas fa-trash"></i></h3>\n          <a href="/home.html#search?q=${encodeURIComponent(e.description)}"><h4 data-view="${e.viewer||"https://media.tenor.com/aGgnqxZUzeUAAAAM/sad.gif"}"><i class="fas fa-eye"></i></h4></a>\n        </div>\n        <p class="product-describe">\n          <strong>${e.name.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong>\n          <br>\n          ${e.description.replace(/</g,"&lt;").replace(/>/g,"&gt;")}\n        </p>\n        <div class="profile" data-bio="${e.auth_bio||""} ‚Ä¢ ${e.auth_skill||""}">\n          <p><img src="${e.auth_img||e.cover||"/assets/images/default.png"}" alt="User_auth-profile">\n          <strong class="user-name">@${e.auth_name?e.auth_name:e.name.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong></p>\n        </div>\n        <div class="buttons">\n          <span class="star-contain"><span class="star-count"></span></span> Likes\n          <span class="amount" data-price="${e.price||0}">‚Ç¶${fn(e.price||0)} <small><b class="sales">${e.sales?e.sales:0}</b> sales</small></span>\n          <a name="${encodeURIComponent(e.description||"")}"><span class="star-contain"><i class="fas fa-share"></i> </span></a>\n        </div>\n      `;a.querySelectorAll(".card").forEach((e=>{e.querySelector(".product-describe");e&&e.querySelector(".buttons a").addEventListener("click",(t=>{navigator.clipboard.writeText(`https://devtem.org/home.html#search?q=${e.querySelector(".buttons a").name||""}`),cAlert("Link copied üéâ","success","Copied")}))})),t.querySelector(".delete-btn").onclick=()=>deletePost(e),a.appendChild(t)}))}catch(e){console.error("Error loading posts:",e)}}publisherForm&&(publisherForm.onsubmit=async e=>{e.preventDefault(),document.querySelector(".sending").style.display="inline-block";const t=await getUser();if(!t)return cAlert("Please log in.");const r=zipInput.files[0];if(!r)return cAlert("Select a ZIP file","warning","Alert");const{data:a,error:n}=await supabase.storage.from("uploads").upload(`${t.id}/${r.name}`,r,{upsert:!0});if(n)return console.error(n),document.querySelector(".sending").style.display="none",cAlert("Upload failed.","warning","Error");const{error:o}=await supabase.from("posts").insert({user_id:t.id,name:document.getElementById("cardName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),description:document.getElementById("cardDes").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),cover:document.getElementById("cardCover").value,viewer:document.getElementById("cardView").value,price:parseFloat(document.getElementById("cardAmount").value),file_path:a.path,star:0,sales:0,auth_bio:authBio,auth_img:authImg,auth_name:authName,auth_skill:authSkill,auth_status:authStatus,auth_fname:authFname,portfolio_url:portfolioUrl});if(o)return console.error(o),document.querySelector(".sending").style.display="none",cAlert("‚ùå Insert failed.","warning","Error");document.querySelector(".sending").style.display="none",loadPosts(),loadProfileStats(),cAlert("Upload successful!","success","Success"),showSection("posts")});const profileForm=document.querySelector('form[name="user edit"]');profileForm&&profileForm.addEventListener("submit",(async e=>{e.preventDefault();const t=profileForm.querySelector(".username").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),r=document.getElementById("fullName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),a=profileForm.querySelector(".bio").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),n=profileForm.querySelector(".skill").value,o=document.getElementById("phone").value,s=(document.getElementById("experience").value,document.getElementById("portfolio").value),i=document.getElementById("imgUrl").files[0];try{const{data:{user:e},error:l}=await supabase.auth.getUser();if(l||!e)throw new Error("Not logged in");let c=null;if(i){const t=i.name.split(".").pop(),r=`avatars/${e.id}.${t}`,{error:a}=await supabase.storage.from("avatars").upload(r,i,{upsert:!0});if(a)throw a;const{data:n}=supabase.storage.from("avatars").getPublicUrl(r);c=n.publicUrl}const{error:d}=await supabase.from("profiles").update({username:t,full_name:r,bio:a,skills:n,phone:o,portfolio_url:s,...c&&{photo_url:c}}).eq("id",e.id);if(d)throw d;cAlert("Profile updated!","success","Success"),loadProfile()}catch(e){console.error("Profile update error:",e.message),cAlert("‚ùå Error updating profile: "+e.message,"warning","Error")}}));const notificationForm=document.getElementById("notificationForm");async function loadSalesSummary(){const e=await getUser();if(e)try{const{data:t,error:r}=await supabase.from("posts").select("id, price, sales, name").eq("user_id",e.id);if(r)return void console.error("Sales summary error:",r);if(!t||0===t.length){const e=document.querySelector(".sales-stats");return void(e&&(e.innerHTML="<p>No products uploaded yet.</p>"))}let a=0,n=0;t.forEach((e=>{const t=e.sales||0,r=e.price||0;a+=r*t,n+=t}));const o=await getAvailableBalance(),s=document.querySelector(".sales-stats");s&&(s.innerHTML=`\n        <div class="card">Total Sales Value: <strong>‚Ç¶${fn(a)}</strong></div>\n        <div class="card">Units Sold: <strong>${fn(n)}</strong></div>\n        <div class="card">Products Listed: <strong>${t.length}</strong></div>\n        <div class="card">Available Balance: <strong>‚Ç¶${fn(o)}</strong></div>\n        ${o>0?`\n          <div class="card" style="border-color: #0a6;">\n            <small>You can withdraw up to ‚Ç¶${fn(o)}</small>\n          </div>\n        `:""}\n      `);const i=document.getElementById("summary-sales"),l=document.getElementById("summary-earnings");i&&(i.textContent="‚Ç¶"+fn(a||0)),l&&(l.textContent="‚Ç¶"+fn(o))}catch(e){console.error("Error in loadSalesSummary:",e);const t=document.querySelector(".sales-stats");t&&(t.innerHTML="<p>Error loading sales data</p>")}}async function loadSalesChart(){const e=await getUser();if(!e)return;const{data:t,error:r}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(r)return void console.error("Chart load error:",r);const a=await Promise.all(t.map((e=>initStar(e.id)))),n=document.getElementById("salesChart");if(!n)return;const o=n.getContext("2d");window.myChart&&window.myChart.destroy(),window.myChart=new Chart(o,{type:"bar",data:{labels:t.map((e=>e.name)),datasets:[{label:"Sales",data:t.map((e=>e.sales||0)),backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:a,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function renderPerformanceChart(){const e=await getUser();if(!e)return;const{data:t,error:r}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(r)return void console.error("Chart load error:",r);const a=await Promise.all(t.map((e=>initStar(e.id)))),n=t.map((e=>e.name)),o=t.map((e=>e.sales||0)),s=document.getElementById("salesChart");if(!s)return;const i=s.getContext("2d");window.performanceChart&&window.performanceChart.destroy(),window.performanceChart=new Chart(i,{type:"bar",data:{labels:n,datasets:[{label:"Sales",data:o,backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:a,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function getAvailableBalance(){const e=await getUser();if(!e)return 0;try{const{data:t,error:r}=await supabase.from("posts").select("price, sales").eq("user_id",e.id);if(r)return console.error("Error loading posts data for earnings:",r),0;const a=t.reduce(((e,t)=>{const r=t.sales||0;return e+.7*((t.price||0)*r)}),0),{data:n,error:o}=await supabase.from("withdraw_requests").select("amount, status").eq("user_id",e.id).in("status",["approved","paid"]);if(o)return console.error("Error loading withdraws:",o),0;const s=a-n.reduce(((e,t)=>e+(t.amount||0)),0);return Math.max(s,0)}catch(e){return console.error("Error in getAvailableBalance:",e),0}}async function requestWithdraw(e,t){const r=await getUser();if(!r)return;const a=await getAvailableBalance();if(e>a)return cAlert(`‚ùå You can only withdraw up to ‚Ç¶${a.toFixed(2)}`,"warning");const{error:n}=await supabase.from("withdraw_requests").insert({user_id:r.id,amount:e,bank_details:t,status:"pending"});if(n)return console.error("Withdraw request failed:",n),void cAlert("Withdraw request failed. Please try again.","warning","Failed");cAlert("Withdraw request submitted for review!"),document.getElementById("withdrawForm").reset()}notificationForm&&notificationForm.addEventListener("submit",(async e=>{e.preventDefault(),cAlert("Notification preferences saved!","success")}));const withdrawForm=document.getElementById("withdrawForm");withdrawForm&&withdrawForm.addEventListener("submit",(async e=>{e.preventDefault();const t=parseFloat(document.getElementById("requestAmt").value),r=document.getElementById("bankDetails").value;r?await requestWithdraw(t,r):cAlert("Please provide your bank details.")}));const deleteAccountBtn=document.getElementById("deleteAccountBtn");deleteAccountBtn&&deleteAccountBtn.addEventListener("click",(async()=>{if(confirm("Are you sure you want to delete your account? This action cannot be undone."))try{const{data:{user:e},error:t}=await supabase.auth.getUser();if(t)throw t;if(!e)throw new Error("No user found. Please log in again.");const r=e.id,a=await fetch("/.netlify/functions/deleteUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:r})}),n=await a.json();if(!a.ok)throw new Error(n.message);cAlert("‚úÖ Account deleted successfully.","success","Deleted"),window.location.href="/"}catch(e){cAlert("‚ùå Error deleting account: "+e.message,"warning","Error")}}));const nGrid=document.querySelector(".notify-grid");async function loadNotifications(){const e=await getUser();if(!e)return;const{data:t,error:r}=await supabase.from("notify").select("*").or(`user_id.eq.${e.id},user_id.is.null`).order("created_at",{ascending:!1});if(r)return console.error(r),void(nGrid.innerHTML='<p class="notify-error">Failed to load notifications.</p>');nGrid.innerHTML=t.map((e=>`\n      <div class="notify-card ${e.type}">\n        <div class="notify-text">${e.text}</div>\n        <span class="notify-time">${new Date(e.created_at).toLocaleString()}</span>\n      </div>\n    `)).join("")}window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},window.addEventListener("DOMContentLoaded",(()=>{loadProfile(),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart(),loadNotifications()}));
