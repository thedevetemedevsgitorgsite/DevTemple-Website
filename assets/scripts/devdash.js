import{createClient}from"https://esm.sh/@supabase/supabase-js@2";function formatLength(e){const t=200-e.length;return t>=1?e+="&nbsp ".repeat(t):e}const sections={user:document.getElementById("user-section"),pen:document.getElementById("pen-section"),sales:document.getElementById("sales-section"),chart:document.getElementById("chart-section"),posts:document.getElementById("posts-section"),notify:document.getElementById("notify-section")};let authBio="creator",authImg="/assets/images/default.png",authName="creator",authSkill="creator",portfolioUrl=" ",authFname="creator",authStatus="pending";function showSection(e){Object.values(sections).forEach((e=>e.classList.add("hidden"))),sections[e]&&sections[e].classList.remove("hidden")}document.querySelector(".top-btn.user").onclick=()=>showSection("user"),document.querySelector(".top-btn.pen").onclick=()=>showSection("pen"),document.querySelector(".top-btn.sales").onclick=()=>{showSection("sales")},document.querySelector(".top-btn.chart").onclick=()=>showSection("chart"),document.querySelector(".top-btn.notify").onclick=()=>showSection("notify");const{url:url,key:key}={url:td,key:tc};export const supabase=createClient(url,key);async function getUser(){const{data:e,error:t}=await supabase.auth.getUser();return t?(console.error("Auth error:",t),null):e?.user||null}async function signOut(){await supabase.auth.signOut(),window.location.href="/signup.html"}async function loadProfile(){const e=await getUser();if(!e)return void(window.location.href="/signup.html");document.querySelector(".user .email").textContent=e.email,document.querySelector(".user .uid").textContent=e.id;const t=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".join-date").textContent=t;const a=new Date(e.last_sign_in_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".last-login").textContent=a;const{data:r}=await supabase.from("profiles").select("*").eq("id",e.id).single();r&&(document.querySelector("#account-status").textContent=r.status,document.querySelector(".status").style.color="pending"===document.querySelector("#account-status").textContent?"#960":"#096",document.getElementById("userName").value=r.username||"",document.getElementById("fullName").value=r.full_name||"",document.getElementById("email").value=e.email,document.getElementById("phone").value=r.phone||"",document.getElementById("bio").value=r.bio||"",document.getElementById("skill").value=r.skills||"",document.getElementById("experience").value=r.experience_level||"",document.getElementById("portfolio").value=r.portfolio_url||"",document.querySelector(".user.img").src=r.photo_url||"/assets/images/default.png",document.getElementById("profileName").textContent=r.full_name||r.username||"User",document.getElementById("profileSkill").textContent=r.skills||"No skill set",document.getElementById("profileName").innerHTML+=` <sup style="font-size: 0.6em;-webkit-text-stroke: 0.2px #0f9;">${"verified"===r.status?"<i class='fas fa-check-circle' style='color:#1DA1F2;'></i>":""}</sup>`,authBio=r.bio||"",authImg=r.photo_url||"/assets/images/default.png",authName=r.username||"",authSkill=r.skills||"",authStatus=r.status||"",authFname=r.full_name||"",portfolioUrl=r.portfolio_url||"",updateBioCharCount()),await loadProfileStats()}function updateBioCharCount(){const e=document.getElementById("bio"),t=document.getElementById("bioCharCount");e&&t&&(t.textContent=e.value.length,e.addEventListener("input",(()=>{t.textContent=e.value.length})))}async function loadProfileStats(){const e=await getUser();if(!e)return;const{data:t}=await supabase.from("posts").select("sales, price").eq("user_id",e.id);if(t){const e=t.length,a=t.reduce(((e,t)=>e+(t.sales||0)),0),r=t.reduce(((e,t)=>e+(t.price||0)*(t.sales||0)),0);document.getElementById("statUploads").textContent=e,document.getElementById("statSales").textContent=a,document.getElementById("statEarnings").onclick=()=>{cAlert(`‚Ç¶${fn(r||0)}`,"success","Total earnings")}}}document.getElementById("logoutBtn").onclick=signOut;const zipInput=document.getElementById("zipInput"),filename=document.querySelector(".file-name");zipInput&&(zipInput.onchange=()=>{filename&&(filename.textContent=zipInput.files[0]?.name||"")});const publisherForm=document.getElementById("publisherForm");async function initStar(e){try{const{count:t,error:a}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(a)throw a;return t||0}catch(e){return console.error("Star init failed:",e),0}}async function deletePost(e){if(confirm(`Delete "${e.name}"? This cannot be undone.`))try{const{error:t}=await supabase.from("stars").delete().eq("post_id",e.id);if(t)return console.error("SDB delete error:",t),void cAlert("‚ùåFailed to delete related stars.","warning","Error");if(e.file_path){const{error:t}=await supabase.storage.from("uploads").remove([e.file_path]);if(t)return console.error("Storage delete error:",t),void cAlert("‚ùåFailed to delete file from storage.","warning","Failed")}const{error:a}=await supabase.from("posts").delete().eq("id",e.id);if(a)return console.error("DB delete error:",a),void cAlert("‚ùåFailed to delete post from Database.","warning","Failed");cAlert("Post deleted!","success","Deleted"),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart()}catch(e){console.error("Unexpected error:",e),cAlert("‚ùåAn unexpected error occurred.","warning","Error")}}async function loadPosts(){try{const e=await getUser();if(!e)return void console.warn("No logged-in user found.");const{data:t,error:a}=await supabase.from("posts").select("id, name, description, price, cover, auth_bio, auth_img, auth_name, star, sales, auth_skill, portfolio_url, auth_fname, auth_status, sponsored, created_at").eq("user_id",e.id).order("created_at",{ascending:!1});if(a)throw a;const r=document.querySelector(".product-grid");if(!r)return;if(r.innerHTML="",!t||0===t.length)return void(r.innerHTML='<p class="empty-msg">You haven\'t uploaded any posts yet.</p>');t.forEach((e=>{const t=document.createElement("div");t.className="card",t.dataset.id=e.id,t.dataset.filePath=e.file_path,t.dataset.sellerId=e.user_id,t.dataset.profileId=e.user_id,t.innerHTML=`\n        <div class="product-img" style="background-image: url(${e.cover||"/assets/images/index.png"});">\n          <h3 class="delete-btn"><i class="fas fa-trash"></i></h3>\n          <a href="/home.html#search?q=${encodeURIComponent(e.description?.slice(0,200).replace(/\&amp\;/,"&").replace(/&gt;/,">").replace(/&lt;/,"<"))}"><h4 data-view="${e.viewer||"https://media.tenor.com/aGgnqxZUzeUAAAAM/sad.gif"}"><i class="fas fa-eye"></i></h4></a>\n        </div>\n  <p class="product-describe">\n    <strong>${e.name?.slice(0,35).replace(/</g,"&lt;").replace(/>/g,"&gt;")}${e.name.length>35?"‚Ä¶":""}  </strong><br>\n    ${formatLength(e.description?.slice(0,200).replace(/</g,"&lt;").replace(/>/g,"&gt;"))}${e.description.length>200?"‚Ä¶":""}\n  </p>\n  <input type="button" value="${new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}">\n        <div class="profile" data-bio="${e.auth_bio||""} ‚Ä¢ ${e.auth_skill||""}">\n          <p><img src="${e.auth_img||e.cover||"/assets/images/default.png"}" alt="User_auth-profile">\n          <strong class="user-name">@${e.auth_name?e.auth_name:e.name.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong></p>\n        </div>\n        <div class="buttons">\n          <span class="star-contain"> <button class="star" data-post-id="${e.id}" style="cursor: pointer; background: none; border: none; color: inherit;">\n        <svg width="23" height="23" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n        </svg></button><span class="star-count"></span></span> <span class="amount" data-price="${e.price||0}">‚Ç¶${fn(e.price||0)} <small><b class="sales">${e.sales?e.sales:0}</b> sold</small></span>\n          <a name="${encodeURIComponent(e.description?.slice(0,200).replace(/\&amp\;/,"&").replace(/&gt;/,">").replace(/&lt;/,"<")||"")}"><span class="star-contain"><i class="fas fa-share"></i> </span></a>\n        </div>\n      `;r.querySelectorAll(".card").forEach((e=>{e.querySelector(".product-describe");e&&e.querySelector(".buttons a").addEventListener("click",(t=>{navigator.clipboard.writeText(`https://devtem.org/home.html#search?q=${e.querySelector(".buttons a").name?.slice(0,75)||""}`),cAlert("Link copied üéâ","success","Copied")}))})),t.querySelector(".delete-btn").onclick=()=>deletePost(e),r.appendChild(t)}))}catch(e){console.error("Error loading posts:",e)}}publisherForm&&(publisherForm.onsubmit=async e=>{e.preventDefault(),document.querySelector(".sending").style.display="inline-block";const t=await getUser();if(!t)return cAlert("Please log in.");const a=zipInput.files[0];if(!a)return cAlert("Select a ZIP file","warning","Alert");const{data:r,error:n}=await supabase.storage.from("uploads").upload(`${t.id}/${a.name}`,a,{upsert:!0});if(n)return console.error(n),document.querySelector(".sending").style.display="none",cAlert("Upload failed.","warning","Error");const{error:o}=await supabase.from("posts").insert({user_id:t.id,name:document.getElementById("cardName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),description:document.getElementById("cardDes").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),cover:document.getElementById("cardCover").value,viewer:document.getElementById("cardView").value,price:parseFloat(document.getElementById("cardAmount").value),file_path:r.path,star:0,sales:0,auth_bio:authBio,auth_img:authImg,auth_name:authName,auth_skill:authSkill,auth_status:authStatus,auth_fname:authFname,portfolio_url:portfolioUrl});if(o)return console.error(o),document.querySelector(".sending").style.display="none",cAlert("‚ùå Insert failed.","warning","Error");document.querySelector(".sending").style.display="none",loadPosts(),loadProfileStats(),cAlert("Upload successful!","success","Success"),showSection("posts"),publisherForm.reset()});const profileForm=document.querySelector('form[name="user edit"]');profileForm&&profileForm.addEventListener("submit",(async e=>{e.preventDefault();const t=profileForm.querySelector(".username").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),a=document.getElementById("fullName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),r=profileForm.querySelector(".bio").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),n=profileForm.querySelector(".skill").value,o=document.getElementById("phone").value,s=(document.getElementById("experience").value,document.getElementById("portfolio").value),i=document.getElementById("imgUrl").files[0];try{const{data:{user:e},error:l}=await supabase.auth.getUser();if(l||!e)throw new Error("Not logged in");let c=null;if(i){const t=i.name.split(".").pop(),a=`avatars/${e.id}.${t}`,{error:r}=await supabase.storage.from("avatars").upload(a,i,{upsert:!0});if(r)throw r;const{data:n}=supabase.storage.from("avatars").getPublicUrl(a);c=n.publicUrl}const{error:d}=await supabase.from("profiles").update({username:t,full_name:a,bio:r,skills:n,phone:o,portfolio_url:s,...c&&{photo_url:c}}).eq("id",e.id);if(d)throw d;cAlert("Profile updated!","success","Success"),loadProfile()}catch(e){console.error("Profile update error:",e.message),cAlert("‚ùå Error updating profile: "+e.message,"warning","Error")}}));const notificationForm=document.getElementById("notificationForm");async function loadSalesSummary(){const e=await getUser();if(e){try{const{data:t,error:a}=await supabase.from("posts").select("id, price, sales, name").eq("user_id",e.id);if(a)return void console.error("Sales summary error:",a);if(!t||0===t.length){const e=document.querySelector(".sales-stats");return void(e&&(e.innerHTML="<p>No products uploaded yet.</p>"))}let r=0,n=0;t.forEach((e=>{const t=e.sales||0,a=e.price||0;r+=a*t,n+=t}));const o=await getAvailableBalance(),s=document.querySelector(".sales-stats");s&&(s.innerHTML=`\n        <div class="card">Total Sales Value: <strong class="contain-number">‚Ç¶${fn(r)}</strong></div>\n        <div class="card">Units Sold: <strong class="contain-number">${fn(n)}</strong></div>\n        <div class="card">Products Listed: <strong class="contain-number" >${t.length}</strong></div>\n        <div class="card">Available Balance: <strong class="contain-number">‚Ç¶${fn(o)}</strong></div>\n        ${o>0?`\n          <div class="card" style="border-color: #0a6;">\n            <small class="contain-number">You can withdraw up to ‚Ç¶${fn(o)}</small>\n          </div>\n        `:""}\n      `);const i=document.getElementById("summary-sales"),l=document.getElementById("summary-earnings");i&&(i.textContent="‚Ç¶"+fn(r||0)),l&&(l.textContent="‚Ç¶"+fn(o))}catch(e){console.error("Error in loadSalesSummary:",e);const t=document.querySelector(".sales-stats");t&&(t.innerHTML="<p>Error loading sales data</p>")}animetNum()}}async function loadSalesChart(){const e=await getUser();if(!e)return;const{data:t,error:a}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(a)return void console.error("Chart load error:",a);const r=await Promise.all(t.map((e=>initStar(e.id)))),n=document.getElementById("salesChart");if(!n)return;const o=n.getContext("2d");window.myChart&&window.myChart.destroy(),window.myChart=new Chart(o,{type:"bar",data:{labels:t.map((e=>e.name)),datasets:[{label:"Sales",data:t.map((e=>e.sales||0)),backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:r,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function renderPerformanceChart(){const e=await getUser();if(!e)return;const{data:t,error:a}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(a)return void console.error("Chart load error:",a);const r=await Promise.all(t.map((e=>initStar(e.id)))),n=t.map((e=>e.name)),o=t.map((e=>e.sales||0)),s=document.getElementById("salesChart");if(!s)return;const i=s.getContext("2d");window.performanceChart&&window.performanceChart.destroy(),window.performanceChart=new Chart(i,{type:"bar",data:{labels:n,datasets:[{label:"Sales",data:o,backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:r,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function getAvailableBalance(){const e=await getUser();if(!e)return 0;try{const{data:t,error:a}=await supabase.from("posts").select("price, sales").eq("user_id",e.id);if(a)return console.error("Error loading posts data for earnings:",a),0;const r=t.reduce(((e,t)=>{const a=t.sales||0;return e+.7*((t.price||0)*a)}),0),{data:n,error:o}=await supabase.from("withdraw_requests").select("amount, status").eq("user_id",e.id).in("status",["approved","paid"]);if(o)return console.error("Error loading withdraws:",o),0;const s=r-n.reduce(((e,t)=>e+(t.amount||0)),0);return Math.max(s,0)}catch(e){return console.error("Error in getAvailableBalance:",e),0}}async function requestWithdraw(e,t){const a=await getUser();if(!a)return;const r=await getAvailableBalance();if(e>r)return cAlert(`‚ùå You can only withdraw up to ‚Ç¶${fn(r)}`,"warning");const{error:n}=await supabase.from("withdraw_requests").insert({user_id:a.id,amount:e,bank_details:t,status:"pending"});if(n)return console.error("Withdraw request failed:",n),void cAlert("Withdraw request failed. Please try again.","warning","Failed");cAlert("Withdraw request submitted for review!"),document.getElementById("withdrawForm").reset()}notificationForm&&notificationForm.addEventListener("submit",(async e=>{e.preventDefault(),cAlert("Notification preferences saved!","success")}));const toggleBtn=document.getElementById("toggleWithdraw"),withdrawForm=document.getElementById("withdrawForm");toggleBtn.addEventListener("click",(()=>{withdrawForm.classList.toggle("hidden"),withdrawForm.classList.contains("hidden")?toggleBtn.textContent="Request Withdraw":toggleBtn.textContent="Hide Form"})),withdrawForm&&withdrawForm.addEventListener("submit",(async e=>{e.preventDefault();const t=parseFloat(document.getElementById("requestAmt").value),a=document.getElementById("bankName").value.trim(),r=document.getElementById("accountName").value.trim(),n=document.getElementById("accountNumber").value.trim(),o=document.getElementById("extraNote").value.trim();if(!a||!r||!n)return void cAlert("Please fill in all required bank details.");if(10!==n.length||isNaN(n))return void cAlert("Please enter a valid 10-digit account number.");const s=`Bank: ${a} | Account Name: ${r} | Account No: ${n}${o?" | Note: "+o:""}`;await requestWithdraw(t,s)}));const deleteAccountBtn=document.getElementById("deleteAccountBtn");deleteAccountBtn&&deleteAccountBtn.addEventListener("click",(async()=>{if(confirm("Are you sure you want to delete your account? This action cannot be undone."))try{const{data:{user:e},error:t}=await supabase.auth.getUser();if(t)throw t;if(!e)throw new Error("No user found. Please log in again.");const a=e.id,r=await fetch("/.netlify/functions/deleteUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a})}),n=await r.json();if(!r.ok)throw new Error(n.message);cAlert("‚úÖ Account deleted successfully.","success","Deleted"),window.location.href="/"}catch(e){cAlert("‚ùå Error deleting account: "+e.message,"warning","Error")}}));const nGrid=document.querySelector(".notify-grid");async function loadNotifications(){const e=await getUser();if(!e)return;const{data:t,error:a}=await supabase.from("notify").select("*").or(`user_id.eq.${e.id},user_id.is.null`).order("created_at",{ascending:!1});if(a)return console.error(a),void(nGrid.innerHTML='<p class="notify-error">Failed to load notifications.</p>');nGrid.innerHTML=t.map((e=>`\n      <div class="notify-card ${e.type}">\n        <div class="notify-text">${e.text}</div>\n        <span class="notify-time">${new Date(e.created_at).toLocaleString()}</span>\n      </div>\n    `)).join("")}window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},window.addEventListener("DOMContentLoaded",(()=>{loadProfile(),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart(),loadNotifications()}));
