
import{createClient as e}from"https://esm.sh/@supabase/supabase-js@2";function formatCount(e){return e>=1e9?(e/1e9).toFixed(1).replace(/\.0$/,"")+"B":e>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":e>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toString()}async function initFor(){document.querySelectorAll(".buttons").forEach((e=>{let t=e.querySelector(".sales"),a=parseInt(t.textContent);t.textContent=formatCount(a),t.dataset.rawCount=a;let n=e.querySelector(".star-count"),r=parseInt(n.textContent);n.dataset.rawCount=r,n.textContent=formatCount(r)}))}window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};let{url:t,key:a}={url:td,key:tc};export const supabase=e(t,a);async function getUser(){let{data:e,error:t}=await supabase.auth.getUser();return t?(console.error("Auth error:",t),null):e?.user||null}async function toggleStar(e,t,a){let n=await getUser();if(!n)return void alert("Please log in to star posts.");let r=n.id;try{let{data:n,error:o}=await supabase.from("stars").select("id").eq("user_id",r).eq("post_id",e).maybeSingle();if(o)throw o;n?(await supabase.from("stars").delete().eq("id",n.id),t.style.background="#ddd"):(await supabase.from("stars").insert({user_id:r,post_id:e}),t.style.background="gold");let{count:s,error:c}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(c)throw c;a.textContent=formatCount(s)}catch(e){console.error("Star toggle failed:",e),cAlert("Could not update star, try again.")}}async function initStar(e,t,a){let n=await getUser();t.style.background="#ddd";try{let{count:r,error:o}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(o)throw o;if(a.textContent=formatCount(r),n){let a=n.id,{data:r,error:o}=await supabase.from("stars").select("id").eq("user_id",a).eq("post_id",e).maybeSingle();if(o)throw o;r&&(t.style.background="gold")}}catch(e){console.error("Star init failed:",e)}}let cart=[],cartBox=document.querySelector(".cart-items"),cartTotalEl=cartBox.querySelector("h4 span"),checkoutBtn=document.createElement("button");function updateCartUI(){cartBox.querySelectorAll(".cart-item").forEach((e=>e.remove()));let e=0;cart.forEach(((t,a)=>{e+=t.price;let n=document.createElement("div");n.className="cart-item",n.innerHTML=`\n      <strong>${t.title}</strong> [ ‚Ç¶${fn(t.price)}]\n      <button data-index="${a}" class="remove">x</button>\n      <small style="color:#d00;max-width:80%;overlay:auto;">Note: don't close or reload the browser when making the payment ‚Äî <a href="/terms/index.html#payment-refunds-heading">More info</a></b></small>\n`,cartBox.insertBefore(n,cartBox.querySelector("h4"))})),cartTotalEl.textContent=e.toFixed(2),cart.length>0?cartBox.contains(checkoutBtn)||cartBox.appendChild(checkoutBtn):cartBox.contains(checkoutBtn)&&checkoutBtn.remove(),cartBox.querySelectorAll(".remove").forEach((e=>{e.onclick=e=>{let t=e.target.dataset.index;cart.splice(t,1),updateCartUI()}}))}function resetCheckoutButton(e,t){e.disabled=!1,e.textContent=t}async function handlePaymentVerification(e){try{console.log("Verifying payment with reference:",e);let t=await fetch("/.netlify/functions/verify-pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:e})}),a=await t.json();console.log("Verification response:",a),a.success?(cAlert("‚úÖ Payment successful! Your downloads are ready."),cart.length=0,updateCartUI(),showDownloadLinks(a.downloadLinks)):cAlert("‚ùå Payment verification failed: "+(a.error||"Unknown error"))}catch(t){console.error("Verification error:",t),cAlert("‚ùå Could not verify payment. Please contact support with reference: "+e)}}function showDownloadLinks(e){let t=cartBox.querySelector(".download-links");t&&t.remove();let a=document.createElement("div");a.className="download-links",a.style.cssText="\n    margin-top: 15px;\n    padding: 15px;\n    border: 2px solid #0a6;\n    border-radius: 8px;\n    background: #f9fff9;\n  ";let n=document.createElement("h4");n.textContent="üì• Your Downloads",n.style.cssText="margin-bottom: 10px; color: #0a6;",a.appendChild(n);let r=document.createElement("p");r.textContent="Links are valid for 24 hours. Click to download:",r.style.cssText="font-size: 14px; color: #666; margin-bottom: 10px;",a.appendChild(r),e.forEach((e=>{let t=document.createElement("div");t.style.cssText="margin: 8px 0; padding: 8px; background: white; border-radius: 4px;";let n=document.createElement("a");n.href=e.url,n.textContent=`Download: ${e.title||"Item "+e.id}`,n.target="_blank",n.style.cssText="\n      display: block;\n      padding: 8px 12px;\n      background: #0a6;\n      color: white;\n      text-decoration: none;\n      border-radius: 4px;\n      text-align: center;\n      font-weight: bold;\n    ",n.onmouseover=()=>n.style.background="#084",n.onmouseout=()=>n.style.background="#0a6",t.appendChild(n),a.appendChild(t),a.innerHTML+='<button onclick="this.parentElement.style.display=\'none\'"><I class="fas fa-times"></i> close</button>'})),cartBox.appendChild(a)}async function verifyPaymentOnReturn(e){try{let t=await fetch("/.netlify/functions/verify-pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:e})}),a=await t.json();a.success?(cAlert("‚úÖ Payment verified! Your downloads are ready."),showDownloadLinks(a.downloadLinks),cart.length=0,updateCartUI(),window.history.replaceState({},document.title,window.location.pathname)):cAlert("‚ùå Payment verification failed: "+a.error)}catch(e){console.error("Verification error:",e),cAlert("‚ùå Could not verify payment. Please contact support.")}}async function loadPosts(){try{let e=await getUser();if(!e)return console.warn("No logged-in user found."),void(document.querySelector(".product").innerHTML='\n    \n    <div class="card">\n    <div class="product-img" style="background-image: url(https://media.tenor.com/2yKn3g52FdgAAAAM/login-required-access-denied-gen-v.gif);">\n        <h3><i class="fas fa-shopping-cart"></i></h3>\n        <h4 data-view="https://media.tenor.com/J3_7mEynzQIAAAAM/ganz.gif"><I class="fas fa-eye"></I></h4>\n    </div>\n    \n    <p class="product-describe">\n    <strong><a href="/signup.html">Sign up/Login</a></strong>\n    <br>\n        \n            </p>\n        <div class="profile" data-name="@DevTemple"\ndata-bio="Official DevTemple ‚Ä¢ü¶∫">\n        <p><img src="/assets/images/20250918_223801.png" alt="User-profile">\n        <strong class="user-name">@DevTemple<I class="fas fa-verify"></I></strong> &nbsp; <sup class="report" style="color:#f50;">Report</sup></p>\n    </div>\n    \n    <div class="buttons">\n        <span class="star-contain"><button class="star"></button><span class="star-count">_</span>\n        </span><span class="amount" data-price="37.05">_ <small><b class="sales">_</b> sales</small></span>\n        <a><span class="star-contain"><i class="fas fa-search"></i> </span></a>\n        </div>\n</div>\n  ');console.log("Current user ID:",e.id);let{data:t,error:a}=await supabase.from("posts").select("id, name, description, price, cover, auth_bio,  auth_img, auth_name, star, sales, auth_skill, file_path, viewer, user_id, portfolio_url, auth_fname, auth_status").order("id",{ascending:!1});if(a)throw a;let n=document.querySelector(".product");if(n.innerHTML="",!t||0===t.length)return void(n.innerHTML='<p class="empty-msg">You haven‚Äôt uploaded any posts yet.</p>');t.forEach((e=>{let t=document.createElement("div");t.className="card",t.dataset.id=e.id,t.dataset.filePath=e.file_path,t.dataset.sellerId=e.user_id,t.innerHTML=`\n  <div class="product-img" style="background-image: url(${e.cover||"/assets/images/index.png"});">\n    <h3><i class="fas fa-shopping-cart"></i></h3>\n    <h4 data-view="${e.viewer||"https://media.tenor.com/rRBWXoBqPikAAAAM/critical-error-error.gif"}"><i class="fas fa-eye"></i></h4>\n  </div>\n  <p class="product-describe">\n    <strong>${e.name.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong><br>\n    ${e.description.replace(/</g,"&lt;").replace(/>/g,"&gt;")}\n  </p>\n  <div class="profile" data-bio="${e.auth_bio||""} ‚Ä¢ ${e.auth_skill||""}">\n    <p>\n      <img src="${e.auth_img||e.cover||"/assets/images/default.png"}" alt="User profile">\n      <strong class="user-name"> ${e.auth_fname||e.name||" "}</strong><sup>${"verified"===e.auth_status?"<i class='fas fa-check-circle' style='color:#1DA1F2;'></i>":""}</sup>\n      &nbsp;<sup class="report" style="color:#f50;">Report</sup>\n      <br/>\n      <small style="font-size: 13px;color: var(--text-dim);">@${e.auth_name||""}</small>\n    </p>\n  </div>\n  <div class="buttons">\n    <span class="star-contain">\n      <button class="star" data-post-id="${e.id}" style="cursor: pointer;"></button>\n      <span class="star-count" data-raw-count="${e.star||0}">\n        ${e.star||0}\n      </span>\n    </span>\n    <span class="amount" data-price="${e.price||0}">‚Ç¶${fn(e.price||0)}\n      <small><b class="sales">${e.sales||0}</b> sales</small>\n    </span>\n    <a href="/home.html#search?q=${encodeURIComponent(e.name)}"><span class="star-contain"><i class="fas fa-search"></i></span></a>\n  </div>\n`,n.appendChild(t);let a=t.querySelector("button.star"),r=t.querySelector(".star-count");t.querySelector(".star-contain").addEventListener("click",(()=>{toggleStar(e.id,a,r)})),t.addEventListener("dblclick",(()=>{toggleStar(e.id,a,r)})),initStar(e.id,a,r);let o=document.querySelector(".product");o.querySelectorAll(".card").forEach((e=>{let t=e.querySelector(".product-describe");e&&(e.querySelector(".buttons a").href=`#search?q=${encodeURIComponent(t.textContent.match(/#[\w-]+/)||"")}`,t.innerHTML=t.innerHTML.replace(/\#([\w\-]+)/g,"<a href='#search?q=$1' class='card-tag'>#$1</a>"),t.querySelectorAll(".card-tag").forEach((e=>{e.style.cssText='color: var(--primary-color);\n          font-family: "ADLaM Display", monospace;\n          text-decoration: none;'})))})),o.querySelectorAll(".card").forEach((e=>{let t=e.querySelector(".product-img h3");t.style.cursor="pointer",t.onclick=()=>{document.querySelector(".search-loader").style.display="flex",setTimeout((()=>{let t=e.dataset.id,a=e.querySelector(".product-describe strong").textContent,n=parseFloat(e.querySelector(".amount").dataset.price),r=e.dataset.filePath;cart.push({id:t,title:a,price:n,filePath:r}),updateCartUI(),document.querySelector(".search-loader").style.display="none"}),1200)}})),document.querySelectorAll(".card .profile").forEach((e=>{e.addEventListener("click",(()=>{document.querySelector(".search-loader").style.display="flex",setTimeout((()=>{let t=e.querySelector(".user-name").textContent,a=e.dataset.bio;a=a.replace(/((https?:\/\/)?(\w+\.[^\s]+))/g,"<a href='$1'>$1</a>");let n=e.querySelector("img").src;document.getElementById("popupName").textContent=t,document.getElementById("schUser").href=`#search?q=${encodeURIComponent(t)}`,document.getElementById("userToRe").value=`User reported: ${t}`,document.getElementById("popupBio").innerHTML=a,document.getElementById("popupImg").src=n,document.getElementById("userView").style.display="block",document.querySelector(".search-loader").style.display="none"}),1500)}))})),document.querySelectorAll("h4[data-view*='/']").forEach((e=>{e.addEventListener("click",(t=>{let a=e.dataset.view||"/assets/images/20250918_223801.png",n=document.querySelector(".video-view"),r=n.querySelector("embed");r.src=a,n.style.display="block",r.style.display="none",document.getElementById("embedLoader").style.display="block",r.onload=function(){document.getElementById("embedLoader").style.display="none",r.style.display="block"}}))}))})),processSearchFromURL()}catch(e){console.error("Error loading posts:",e)}}checkoutBtn.textContent="Checkout with Paystack",checkoutBtn.className="checkout-btn",checkoutBtn.style.cssText="\n  background: #0a6;\n  color: #fff;\n  border: none;\n  padding: 8px 14px;\n  margin-top: 5px;\n  border-radius: 5px;\n  cursor: pointer;\n",checkoutBtn.onclick=async function(){if(0===cart.length)return void cAlert("Cart is empty");let e=checkoutBtn.textContent;checkoutBtn.disabled=!0,checkoutBtn.textContent="Processing...";try{let t=await getUser(),a=t?.email;if(!a){if(!(a=prompt("Enter your email to continue:")))return resetCheckoutButton(checkoutBtn,e),void alert("Email is required for payment");if(!a.includes("@")||!a.includes("."))return resetCheckoutButton(checkoutBtn,e),void alert("Please enter a valid email address")}console.log("Sending checkout request:",{email:a,cart:cart});let n=await fetch("/.netlify/functions/create-pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,cart:cart.map((e=>({id:e.id,title:e.title,price:e.price,sellerId:e.sellerId,filePath:e.filePath,sales:e.sales||0})))})}),r=await n.json();if(console.log("Checkout response:",r),!n.ok||r.error){let e=r.error||"Payment initialization failed";throw Error(e)}if(!r.authorization_url)throw Error("No payment URL received from server");let o=100*cart.reduce(((e,t)=>e+t.price),0),s=function(t){console.log("Paystack callback triggered:",t),resetCheckoutButton(checkoutBtn,e),handlePaymentVerification(t.reference)},c=function(){console.log("Payment window closed"),resetCheckoutButton(checkoutBtn,e),alert("Payment window closed. You can complete the payment later.")};PaystackPop.setup({key:"pk_live_0b0770be1e29f5e7a159b39d2d9bdc2c41785306",email:a,amount:o,currency:"NGN",ref:r.reference,callback:s,onClose:c}).openIframe()}catch(t){console.error("Checkout error:",t),cAlert("‚ùå Checkout failed: "+t.message),resetCheckoutButton(checkoutBtn,e)}},document.addEventListener("DOMContentLoaded",(()=>{let e=new URLSearchParams(window.location.search).get("reference");e&&verifyPaymentOnReturn(e),loadPosts()})),document.addEventListener("DOMContentLoaded",(()=>{loadPosts()}));
