import{createClient}from"https://esm.sh/@supabase/supabase-js@2";function formatCount(e){return e>=1e9?(e/1e9).toFixed(1).replace(/\.0$/,"")+"B":e>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":e>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toString()}function formatLength(e){const t=200-e.length;return t>=1?e+="&nbsp ".repeat(t):e}async function initFor(){document.querySelectorAll(".buttons").forEach((e=>{const t=e.querySelector(".sales"),n=parseInt(t.textContent);t.textContent=formatCount(n),t.dataset.rawCount=n;const o=e.querySelector(".star-count"),r=parseInt(o.textContent);o.dataset.rawCount=r,o.textContent=formatCount(r)}))}const{url:url,key:key}={url:td,key:tc};export const supabase=createClient(url,key);async function getUser(){const{data:e,error:t}=await supabase.auth.getUser();return t?(console.error("Auth error:",t),null):e?.user||null}async function toggleStar(e,t,n){const o=await getUser();if(!o)return void cAlert("Please log in to star posts.","warning","User Author");const r=o.id;try{const{data:o,error:a}=await supabase.from("stars").select("id").eq("user_id",r).eq("post_id",e).maybeSingle();if(a)throw a;o?(await supabase.from("stars").delete().eq("id",o.id),t.style.color="#ddd"):(await supabase.from("stars").insert({user_id:r,post_id:e}),t.style.color="red");const{count:s,error:c}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(c)throw c;n.textContent=formatCount(s)}catch(e){console.error("Star toggle failed:",e),cAlert("Could not update like, try again.","warning","not added")}}async function initStar(e,t,n){const o=await getUser();t.style.color="#ddd";try{const{count:r,error:a}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(a)throw a;if(n.textContent=formatCount(r),o){const n=o.id,{data:r,error:a}=await supabase.from("stars").select("id").eq("user_id",n).eq("post_id",e).maybeSingle();if(a)throw a;r&&(t.style.color="red")}}catch(e){console.error("Star init failed:",e)}}window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};const cart=[],cartBox=document.querySelector(".cart-items"),cartTotalEl=cartBox.querySelector("h4 span");let checkoutBtn=document.createElement("button");function updateCartUI(){cartBox.querySelectorAll(".cart-item").forEach((e=>e.remove()));let e=0;cart.forEach(((t,n)=>{e+=t.price;const o=document.createElement("div");o.className="cart-item",o.innerHTML=`\n      <strong>${t.title}</strong> [ ‚Ç¶${fn(t.price)}]\n      <button data-index="${n}" class="remove">x</button>\n      <small style="color:#d00;max-width:80%;overlay:auto;">Note: don't close or reload the browser when making the payment ‚Äî <a href="/terms/index.html#payment-refunds-heading">More info</a></b></small>\n`,cartBox.insertBefore(o,cartBox.querySelector("h4"))})),cartTotalEl.textContent=e.toFixed(2),cart.length>0?cartBox.contains(checkoutBtn)||cartBox.appendChild(checkoutBtn):cartBox.contains(checkoutBtn)&&checkoutBtn.remove(),cartBox.querySelectorAll(".remove").forEach((e=>{e.onclick=e=>{const t=e.target.dataset.index;cart.splice(t,1),updateCartUI()}}))}function resetCheckoutButton(e,t){e.disabled=!1,e.textContent=t}async function handlePaymentVerification(e){try{console.log("Verifying payment with reference:",e);const t=await fetch("/.netlify/functions/verify-pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:e})}),n=await t.json();console.log("Verification response:",n),n.success?(cAlert("‚úÖ Payment successful! Your downloads are ready.","success","Success"),cart.length=0,updateCartUI(),showDownloadLinks(n.downloadLinks)):cAlert("‚ùå Payment verification failed: "+(n.error||"Unknown error"),"warning","initial error")}catch(t){console.error("Verification error:",t),cAlert("‚ùå Could not verify payment. Please contact support with reference: "+e,"warning","initial error")}}function showDownloadLinks(e){const t=cartBox.querySelector(".download-links");t&&t.remove();const n=document.createElement("div");n.className="download-links",n.style.cssText="\n    margin-top: 15px;\n    padding: 15px;\n    border: 2px solid #0a6;\n    border-radius: 8px;\n    background: #f9fff9;\n  ";const o=document.createElement("h4");o.textContent="üì• Your Downloads",o.style.cssText="margin-bottom: 10px; color: #0a6;",n.appendChild(o);const r=document.createElement("p");r.textContent="Links are valid for 24 hours. Click to download:",r.style.cssText="font-size: 14px; color: #666; margin-bottom: 10px;",n.appendChild(r),e.forEach((e=>{const t=document.createElement("div");t.style.cssText="margin: 8px 0; padding: 8px; background: white; border-radius: 4px;";const o=document.createElement("a");o.href=e.url,o.textContent=`Download: ${e.title||"Item "+e.id}`,o.target="_blank",o.style.cssText="\n      display: block;\n      padding: 8px 12px;\n      background: #0a6;\n      color: white;\n      text-decoration: none;\n      border-radius: 4px;\n      text-align: center;\n      font-weight: bold;\n    ",o.onmouseover=()=>o.style.background="#084",o.onmouseout=()=>o.style.background="#0a6",t.appendChild(o),n.appendChild(t),n.innerHTML+='<button onclick="this.parentElement.style.display=\'none\'"><I class="fas fa-times"></i> close</button>'})),cartBox.appendChild(n)}async function verifyPaymentOnReturn(e){try{const t=await fetch("/.netlify/functions/verify-pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:e})}),n=await t.json();n.success?(cAlert("‚òë Payment verified! Your downloads are ready.","warning","Verified"),showDownloadLinks(n.downloadLinks),cart.length=0,updateCartUI(),window.history.replaceState({},document.title,window.location.pathname)):cAlert("‚ùå Payment verification failed: "+n.error,"warning","initial error")}catch(e){console.error("Verification error:",e),cAlert("‚ùå Could not verify payment. Please contact support.","warning","Unknown error")}}async function loadPosts(e="id",t=!1){try{if(!await getUser())return console.warn("No logged-in user found."),void(document.querySelector(".product").innerHTML='\n        <div class="card">\n          <div class="product-img" style="background-image: url(https://media.tenor.com/2yKn3g52FdgAAAAM/login-required-access-denied-gen-v.gif);">\n            <h3><svg width="24" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>\n      </svg></h3>\n            <h4 data-view="https://media.tenor.com/J3_7mEynzQIAAAAM/ganz.gif"><svg width="24" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>\n      </svg></h4>\n          </div>\n          <p class="product-describe">\n            <strong><a href="/signup.html">Sign up/Login</a></strong><br>\n          </p>\n          <div class="profile" data-name="@DevTemple" data-bio="Official DevTemple ‚Ä¢ü¶∫">\n            <p><img src="/assets/images/20250918_223801.png" alt="User-profile">\n            <strong class="user-name">@DevTemple<I class="fas fa-verify"></I></strong> &nbsp; <sup class="report" style="color:#f50;">Report</sup></p>\n          </div>\n          <div class="buttons">\n            <span class="star-contain"><button class="star fas fa-heart"></button><span class="star-count">_</span></span>\n            <span class="amount" data-price="37.05">_ <small><b class="sales">_</b> sales</small></span>\n            <a><span class="star-contain"><i class="fas fa-search"></i> </span></a>\n          </div>\n        </div>\n      ');const{data:n,error:o}=await supabase.from("posts").select("id, name, description, price, cover, star, sales, file_path, viewer, user_id, portfolio_url, sponsored, created_at").order(e,{ascending:t});if(o)throw o;const r=document.querySelector(".product");if(r.innerHTML="",!n||0===n.length)return void(r.innerHTML='<p class="empty-msg">You haven\'t uploaded any posts yet.</p>');const a=[...new Set(n.map((e=>e.user_id)))],{data:s,error:c}=await supabase.from("profiles").select("id, username, full_name, photo_url, bio, skills, status").in("id",a);c&&console.error("Error fetching profiles:",c);const i=new Map(s?.map((e=>[e.id,e]))||[]);n.forEach((e=>{const t=i.get(e.user_id)||{},n=document.createElement("div");n.className="card",n.dataset.id=e.id,n.dataset.filePath=e.file_path,n.dataset.sellerId=e.user_id,n.dataset.profileId=e.user_id,n.innerHTML=`\n  <div class="product-img" style="background-image: url(${e.cover||"/assets/images/index.png"});">\n    <h3 style="visibility:${"n"!==e.sponsored?"hidden":"visible"}"><svg width="24" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>\n      </svg></h3>\n    <h4 data-view="${e.viewer||"https://media.tenor.com/rRBWXoBqPikAAAAM/critical-error-error.gif"}" class="${"n"!==e.sponsored?"ad":""}" ${"n"!==e.sponsored?"onclick='null'":""}>${"n"!==e.sponsored?"AD":'<svg width="24" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>\n      </svg>'}</h4>\n  </div>\n  <p class="product-describe">\n    <strong>${e.name.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong><br>\n    ${formatLength(e.description.replace(/</g,"&lt;").replace(/>/g,"&gt;"))}\n  </p>\n  <input type="${"n"!==e.sponsored?"button":"hidden"}" class="learn-more" value="Learn more" onclick="window.location.href=('${e.sponsored}')"/>\n  <div class="profile" data-bio="${t.bio||""} ‚Ä¢ ${t.skills||""}" name="${encodeURIComponent(e.name)}">\n    <p>\n      <img src="${t.photo_url||e.cover||"/assets/images/default.png"}" alt="User profile" loading="lazy">\n      <strong class="user-name">${t.full_name||e.name||" "}</strong>\n      <sup>${"verified"===t.status?'<svg width="14" height="14" viewBox="0 0 24 24" fill="#1DA1F2">\n          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n        </svg>':""}\n      </sup>\n      &nbsp;<sup class="report" style="color:#f50;">Report</sup>\n      <br/>\n      <small style="font-size: 13px;color: var(--text-dim);">@${t.username||""}</small>\n    </p>\n  </div>\n  <div class="buttons">\n    <span class="star-contain">\n      <button class="star" data-post-id="${e.id}" style="cursor: pointer; background: none; border: none; color: inherit;">\n        <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n        </svg></button><span class="star-count" data-raw-count="${e.star||0}">\n        ${e.star||0}\n      </span>\n    </span>\n    <span class="amount" data-price="${e.price||0}" style="visibility:${"n"!==e.sponsored?"hidden":"visible"}">‚Ç¶${fn(e.price||0)}\n      <small><b class="sales">${e.sales||0}</b> sales</small>\n    </span>\n    <a name="${encodeURIComponent(e.description||"")}">\n      <span class="star-contain">\n        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>\n        </svg>\n      </span>\n    </a>\n  </div>\n`,r.appendChild(n);const o=n.querySelector("button.star"),a=n.querySelector(".star-count");n.querySelector(".star-contain").addEventListener("click",(()=>{toggleStar(e.id,o,a)})),n.addEventListener("dblclick",(()=>{toggleStar(e.id,o,a)})),initStar(e.id,o,a)}));const l=document.querySelector(".product");l.querySelectorAll(".card").forEach((e=>{const t=e.querySelector(".product-describe");e&&(e.querySelector(".buttons a").addEventListener("click",(t=>{navigator.clipboard.writeText(`https://devtem.org/home.html#search?q=${e.querySelector(".buttons a").name?.slice(0,70)||""}`),cAlert("Link copied!üéâ","success","Copied")})),t.innerHTML=t.innerHTML.replace(/\#([\w\-]+)/g,"<a href='#search?q=$1' class='card-tag'>#$1</a>"),t.querySelectorAll(".card-tag").forEach((e=>{e.style.cssText='color: var(--primary-color);\n            font-family: "ADLaM Display", monospace;\n            text-decoration: none;'})))})),l.querySelectorAll(".card").forEach((e=>{const t=e.querySelector(".product-img h3");t.style.cursor="pointer",t.onclick=()=>{document.querySelector(".search-loader").style.display="flex",setTimeout((()=>{const t=e.dataset.id,n=e.querySelector(".product-describe strong").textContent,o=parseFloat(e.querySelector(".amount").dataset.price),r=e.dataset.filePath;cart.push({id:t,title:n,price:o,filePath:r}),updateCartUI(),document.querySelector(".search-loader").style.display="none",cartBox.classList.remove("collapsed"),cartBox.style.display="block",icon.innerHTML="&times;"}),800)}})),document.querySelectorAll(".card .profile").forEach((e=>{e.addEventListener("click",(async t=>{document.querySelector(".search-loader").style.display="flex";const n=e.closest(".card").dataset.profileId;try{const{data:t,error:o}=await supabase.from("profiles").select("username, full_name, photo_url, bio, skills, status, created_at, portfolio_url").eq("id",n).single();if(o)throw o;const{data:r,error:a}=await supabase.from("posts").select("id, sales, star").eq("user_id",n),s=r?.length||0,c=r?.reduce(((e,t)=>e+(t.sales||0)),0)||0,i=(r?.length>0&&(r.reduce(((e,t)=>e+(t.star||0)),0)/r.length).toFixed(1),t.full_name||t.username);let l=t.bio||"No bio available";l=l.replace(/((https?:\/\/)?(\w+\.[^\s]+))/g,"<a href='$1' target='_blank'>$1</a>");const d=t.photo_url||"/assets/images/default.png",u=new Date(t.created_at).toLocaleDateString("en-US",{month:"short",year:"numeric"});document.getElementById("popupName").textContent=i,document.getElementById("popupUsername").textContent=`@${t.username}`,document.getElementById("popupBio").innerHTML=l,document.getElementById("popupImg").src=d||"";const p=document.getElementById("userStatus");"verified"===t.status?(p.classList.add("verified"),p.title="Verified Creator"):(p.classList.remove("verified"),p.title="Active"),document.getElementById("userPosts").textContent=s,document.getElementById("userSales").textContent=c,document.getElementById("userRating").textContent="!",document.getElementById("joinedText").textContent=`Joined ${u}`,t.skills?(document.getElementById("userSkills").style.display="flex",document.getElementById("skillsText").textContent=t.skills||"creator"):document.getElementById("userSkills").style.display="none",t.portfolio_url?(document.getElementById("userWebsite").style.display="flex",document.getElementById("websiteLink").href=t.portfolio_url):document.getElementById("userWebsite").style.display="none",document.getElementById("schUser").href=`#search?q=${encodeURIComponent(t.username)}`,document.getElementById("userToRe").value=`User reported: ${i} (@${t.username}) targeted post‚Äî{${decodeURIComponent(e.name||"")}}`,document.getElementById("userView").style.display="flex"}catch(e){console.error("Error fetching live profile:",e),cAlert("Error loading profile","error","Error")}finally{document.querySelector(".search-loader").style.display="none"}}))}));document.querySelectorAll("h4[data-view*='/']").forEach((e=>{e.addEventListener("click",(t=>{const n=e.dataset.view||"/assets/images/20250918_223801.png",o=document.querySelector(".video-view"),r=o.querySelector("embed")||o.querySelector(".video");r.src=n,o.style.display="block",r.style.display="none",document.getElementById("embedLoader").style.display="block",r.onload=function(){document.getElementById("embedLoader").style.display="none",r.style.display="block"}}))})),processSearchFromURL();const d=document.querySelector(".top-menu.main form input").value.trim();d&&filterCrips(d.toUpperCase())}catch(e){console.error("Error loading posts:",e)}}checkoutBtn.textContent="Checkout with Paystack",checkoutBtn.className="checkout-btn",checkoutBtn.style.cssText="\n  background: #0a6;\n  color: #fff;\n  border: none;\n  padding: 8px 14px;\n  margin-top: 5px;\n  border-radius: 5px;\n  cursor: pointer;\n",checkoutBtn.onclick=async function(){if(0===cart.length)return void cAlert("Cart is empty");const e=checkoutBtn.textContent;checkoutBtn.disabled=!0,checkoutBtn.textContent="Processing...";try{const t=await getUser();let n=t?.email;if(!n){if(n=prompt("Enter your email to continue:"),!n)return resetCheckoutButton(checkoutBtn,e),void cAlert("Email is required for payment","warning");if(!n.includes("@")||!n.includes("."))return resetCheckoutButton(checkoutBtn,e),void cAlert("Please enter a valid email address","warning")}console.log("Sending checkout request:",{email:n,cart:cart});const o=await fetch("/.netlify/functions/create-pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,cart:cart.map((e=>({id:e.id,title:e.title,price:e.price,sellerId:e.sellerId,filePath:e.filePath,sales:e.sales||0})))})}),r=await o.json();if(console.log("Checkout response:",r),!o.ok||r.error){let e=r.error||"Payment initialization failed";throw new Error(e)}if(!r.authorization_url)throw new Error("No payment URL received from server");const a=100*cart.reduce(((e,t)=>e+t.price),0),s=function(t){console.log("Paystack callback triggered:",t),resetCheckoutButton(checkoutBtn,e),handlePaymentVerification(t.reference)},c=function(){console.log("Payment window closed"),resetCheckoutButton(checkoutBtn,e),cAlert("Payment window closed. You can complete the payment later.")};PaystackPop.setup({key:"pk_live_0b0770be1e29f5e7a159b39d2d9bdc2c41785306",email:n,amount:a,currency:"NGN",ref:r.reference,callback:s,onClose:c}).openIframe()}catch(t){console.error("Checkout error:",t),cAlert("‚ùå Checkout failed: "+t.message,"warning","Initial error"),resetCheckoutButton(checkoutBtn,e)}},document.addEventListener("DOMContentLoaded",(()=>{const e=new URLSearchParams(window.location.search).get("reference");e&&verifyPaymentOnReturn(e),loadPosts()})),document.addEventListener("DOMContentLoaded",(()=>{loadPosts("id",!1),document.querySelector(".top-btn.all-post").addEventListener("click",(async e=>{loadPosts("id",!1)})),document.querySelector(".top-btn.latest-post").addEventListener("click",(async e=>{loadPosts("created_at",!1)})),document.querySelector(".top-btn.popular-post").addEventListener("click",(async e=>{loadPosts("sales",!1)}))}));
