<!DOCTYPE html>
<html lang="en">  
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <link rel="stylesheet" href="/assets/styles/dash.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Audiowide">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
     <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans">
 <link rel="icon" href="https://i.ibb.co/JDrRS3L/DevTemp.jpg">
 <meta name="describe" content="Your one-stop hub for web templates, code snippets, and professional development services.">
 <meta property="og:image" content="https://i.ibb.co/JDrRS3L/DevTemp.jpg">
 <meta property="og:image:height" content="1200">
 <meta property="og:image:width" content="400">
    <script src="" defer></script>
    <script src="https://kit.fontawesome.com/a076d05399" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/fscss@1.1.7/e/exec.min.js" defer></script>
   <style>
       body{
           $font: @random([Poppins, Roboto, Open Sans]);
           font-family: "$font!", sans-serif;
           exec(_log, $font!)
       }
   </style>
</head>
<body>
  <section class="top-menu">
    <button class="top-btn back" onclick="goBack()">
      <I class="fas fa-arrow-left"></i>
    </button>
    <script>
    function goBack() {
if (window.history.length > 1) {
window.history.back();
} else {
window.location.href = "/";
}
}</script>
<button class="top-btn user"><i class="fas fa-user"></i></button>
<button class="top-btn pen"><I class="fas fa-pen"></I></button>
<button class="top-btn sales"><i class="fas fa-bank"></i></button>
<button class="top-btn chart"><i class="fas fa-chart-line"></i></button>
  </section>
  <main>
  
      
      
  <section id="hero" class="hero">
    <h2></h2>
    <p>Manage your uploads, check sales, and track performance.</p>
  </section>

  <section id="user-section" class="section user hidden">
<div class="view public">
              <img src="/assets/images/20250918_223801.png" class="user img" class="img" onclick="sendAlert('your profile picture', '#5f0')"/>
              <form name="user edit">
     <h3>Profile information</h3>
     
     <label for="userName">UserName</label> <input type="text" maxlength="30" required placeholder="Username*" name="user-name" minlength="3" id="userName" class="username">
     
     <label for="bio">Bio</label><textarea minlength="10" maxlength="200" required placeholder="Let people know a little bit about you*" name="bio" id="bio" class="bio"></textarea>
     <label for="skill">Skill</label>
     <select name="skills" required id="skill" class="skill">
         <option value="">What's your skills*</option>
         <!-- Tech Skills -->
         <option value="software_developer">Software Developer</option>
         <option value="web_developer">Web Developer</option>
         <option value="data_scientist">Data Scientist</option>
         <option value="machine_learning_engineer">Machine Learning Engineer</option>
         <option value="cloud_architect">Cloud Architect</option>
         <option value="devops_engineer">DevOps Engineer</option>
         <option value="cybersecurity_analyst">Cybersecurity Analyst</option>
         <option value="mobile_app_developer">Mobile App Developer</option>
         <option value="ui_ux_designer">UI/UX Designer</option>
         <option value="data_analyst">Data Analyst</option>
         <option value="backend_developer">Backend Developer</option>
         <option value="frontend_developer">Frontend Developer</option>
         <option value="full_stack_developer">Full Stack Developer</option>
         <option value="database_administrator">Database Administrator</option>
         <option value="ai_engineer">AI Engineer</option>
         <option value="blockchain_developer">Blockchain Developer</option>
         <option value="systems_administrator">Systems Administrator</option>
         <option value="qa_engineer">QA Engineer</option>
         <!-- Non-Tech Skills -->
         <option value="project_management">Project Management</option>
         <option value="business_analysis">Business Analysis</option>
         <option value="marketing">Marketing</option>
         <option value="content_creation">Content Creation</option>
         <option value="human_resources">Human Resources</option>
         <option value="financial_analysis">Financial Analysis</option>
         <option value="sales">Sales</option>
         <option value="customer_service">Customer Service</option>
         <option value="public_relations">Public Relations</option>
         <option value="operations_management">Operations Management</option>
         <option value="event_planning">Event Planning</option>
         <option value="supply_chain_management">Supply Chain Management</option>
         <option value="training_and_development">Training and Development</option>
         <option value="legal_advisory">Legal Advisory</option>
         <option value="administrative_support">Administrative Support</option>
         <!-- Creative Skills -->
         <option value="graphic_design">Graphic Design</option>
         <option value="illustration">Illustration</option>
         <option value="video_editing">Video Editing</option>
         <option value="motion_graphics">Motion Graphics</option>
         <option value="photography">Photography</option>
         <option value="creative_writing">Creative Writing</option>
         <option value="animation">Animation</option>
         <option value="game_design">Game Design</option>
         <option value="fashion_design">Fashion Design</option>
         <option value="interior_design">Interior Design</option>
         <option value="music_production">Music Production</option>
         <option value="copywriting">Copywriting</option>
         <option value="visual_arts">Visual Arts</option>
         <option value="product_design">Product Design</option>
         <option value="branding">Branding</option>
     </select>
     <label for="imgUrl">Photo</label>
     <input type="file" name="photo" placeholder="Profile picture" id="imgUrl" accept="image/*">
<button type="submit">Save</button>
              </form>
              
          </div>
          <div class="view private">
              <div class="user-info">
                  <p>
                      <strong>Email:</strong> <span class="email">sample@domain.host</span>
                      </p>
                  <p>
                      <strong>ID :</strong> <span class="uid"> abc122</span>
                  </p>
                  <button class="user-btn logout">Log out</button>
                  <button class="user-btn delete-acct" id="delete-account">Delete Account</button>
              </div>
          </div>
          <div class="view withdraw">
              <from id="withdrawForm">
                  <h3>Withdraw request</h3>
                  <form>
                     <label for="" >Amount: $</label><input type="number" required maxlength="6" minlength="1" id="requestAmt"><button type="submit">Send</button>
                  </form>
              </from>
          </div>
  </section>

  <section id="pen-section" class="section pen hidden">
   <div class="view new-upload">
              <form id="publisherForm">
                  
              
              <label for="zipInput" class="user-btn upload-btn">Upload zip file <span class="file-name"></span></label>
              <input type="file" accept="application/zip" id="zipInput" hidden required/>
              <label for="cardName">Name:</label>
              <input type="text" id="cardName" placeholder="(e.g: 3d box with efforts)" maxlength="100" required>
              <br>
              <label for="cardDes">Description: </label>
              <textarea name="" id="cardDes" maxlength="300" placeholder="describe your code include tags " required></textarea>
              <br>
              <label for="cardCover">Cover Photo:</label>
<input type="url" id="cardCover" placeholder="(e.g: https://....png)" required>
<br>
<label for="cardView">Viewers image:</label>
<input type="url" id="cardView" placeholder="(e.g: ...png, gif, short video mp4)" required>
<br>
<label for="cardAmount">Amount:</label>
<input type="number" id="cardAmount" placeholder="(e.g: 10=$10)" maxlength="100" required>
<br>
              <button id="pushCard"  class="user-btn publish"><span class="sending"> </span> Publish</button>
              </form>
          </div>
  </section>

  <section id="sales-section" class="section sales hidden">
<section id="summary-section" class="section summary">
    <h3>Dashboard Summary</h3>
    <div class="summary-grid">
        <div class="summary-card sales-stats">
            <i class="fas fa-upload"></i>
            <div>
                <p>Total Uploads</p>
                <h4 id="summary-uploads">0</h4>
            </div>
        </div>
        <div class="summary-card">
            <i class="fas fa-dollar-sign"></i>
            <div>
                <p>Total Sales</p>
                <h4 id="summary-sales">$0</h4>
            </div>
        </div>
        <div class="summary-card">
            <i class="fas fa-eye"></i>
            <div>
                <p>Total Views</p>
                <h4 id="summary-views">0</h4>
            </div>
        </div>
        <div class="summary-card">
            <i class="fas fa-wallet"></i>
            <div>
                <p>Earnings</p>
                <h4 id="summary-earnings">$0</h4>
            </div>
        </div>
    </div>
</section>
  </section>

  <section id="posts-section" class="section posts hidden">

  </section>

  <section id="chart-section" class="section static hidden">
    <h3>Performance</h3>
    <canvas id="salesChart"></canvas>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    
</script>
    
    <div class="product-grid">
        
    </div>
  </section>

<section class="video-view">
    <h3 onclick="this.parentElement.style.display='none'"><i class="fas fa-times"></i></h3>
    <div style="text-align: center;display: flex;justify-content: center;"><embed src="https://media.tenor.com/xfrF7juLowwAAAAM/vatnik-detected.gif" class="video" autoplay></div>
    
    <div id="embedLoader">
        
        <p><img src="/assets/images/20250918_223801.png" width="30" height="30" style=""></p>
        <p>loading...</p>
        </div>
        
</section>


  </main>
  <section class="alert-container">
  <div class="alert">
      <p class="msg">Says: alert</p>
      <button class="ok-btn" onclick="this.parentElement.parentElement.style.display='none';">ok</button>
  </div>
  </section>
  
  <script>
      const zipInput = document.getElementById("zipInput");
      const filename = document.querySelector(".file-name");
      zipInput.onchange = function(){
          filename.textContent=zipInput.value;
      }
      
  </script>
  <script>
const sections = {
  user: document.getElementById("user-section"),
  pen: document.getElementById("pen-section"),
  sales: document.getElementById("sales-section"),
  chart: document.getElementById("chart-section"),
  posts: document.getElementById("posts-section")
};

function showSection(name) {
  Object.values(sections).forEach(sec => sec.classList.add("hidden"));
  if (sections[name]) {
    sections[name].classList.remove("hidden");
  }
}

// Attach menu events
document.querySelector(".top-btn.user").onclick = () => showSection("user");
document.querySelector(".top-btn.pen").onclick = () => showSection("pen");
document.querySelector(".top-btn.sales").onclick = () => showSection("sales");
document.querySelector(".top-btn.chart").onclick = () => showSection("chart");

if(!document.getElementById('theme-toggle')){
  themeEle = document.createElement("div");
  themeEle.id="theme-toggle";
  themeEle.hidden=true;
  themeEle.style.display="none";
  document.body.appendChild(themeEle);
}

function sendAlert(massage, color="#ddd"){
    const alertCont = document.querySelector(".alert-container");
    if(alertCont){
        alertCont.style.display="flex";
        alertCont.querySelector(".alert p").textContent=massage;
        alertCont.querySelector(".alert p").style.color=color;
    }
}


let themeToggle = document.getElementById('theme-toggle');

// Load saved theme on page load
if (localStorage.getItem('theme') === 'dark') {
    document.documentElement.classList.add('dark-theme');
}

// Add a single click event listener
themeToggle.addEventListener('click', function() {
    document.documentElement.classList.toggle('dark-theme');
    if (document.documentElement.classList.contains('dark-theme')) {
        localStorage.setItem('theme', 'dark');
    } else {
        localStorage.setItem('theme', 'light');
    }
});



</script>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
 <section class="footer-about">
     <strong>Developers Temple</strong>
 </section>
 
 <section class="side">
     <nav>
         <ul>
             <strong>Templates</strong>
             <a href="/home.html#search?q=best"><li>Best Deals</li></a>
             <a href="/home.html"><li>Available Offers</li></a>
         </ul>
         <ul>
             <strong>DevTemple</strong>
             <a href="/"><li>Home</li></a>
             <a href="/home.html"><li>Templates</li></a>
             <a href="/dashboard"><li>Dashboard</li></a>
             <a href="/terms/index.html"><li>Terms </li></a>
             <a href="/terms/privacy.html"><li>Privacy Policy</li></a>
             <a href="#about"><li>About</li></a>
             <a href="#contact"><li>Contact</li></a>
         </ul>
         <ul>
             <strong>Team Products</strong>
             <a href="/home.html"><li>Templates</li></a>
             <a href="//fscss.onrender.com"><li>FSCSS</li></a>
         </ul>
         <ul>
             <strong>Reach us</strong>
             <a href="https://www.facebook.com/share/1FB4GtT81U/"><li><i class="fab fa-facebook"></i> Facebook</li></a>
             <a href="https://x.com/fscss_ttr"><li><I class="fab fa-twitter"></i> X-Twitter</li></a>
             <a href="https://github.com/fscss-ttr/"><li><I class="fab fa-github"></I> GitHub</li></a>
             <a href="https://codepen.io/David-Hux/"><li><I class="fab fa-codepen"></i> ConPen</li></a>
         </ul>
     </nav>
 </section>
 <section class="conclusion">
     Built with ❤️ by the DevTemple Team
     <p>
         ©2025 DevTemple | All rights reserved
     </p>
 </section>
        </div>
    </footer>
    
    <section class="search-loader"><img src="/assets/images/20250918_223801.png" width="40" height="40" style="margin-top: 10px;animation:spin-bor 2s ease-in-out infinite;border-radius: 50%;border: 1px solid var(--primary-color);border-right: 0;"></section>
    <section class="loader">
  <img src="/assets/images/20250918_223801.png" alt="Loading...">
</section>
    <style>
        .loader {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #112;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}

.loader img {
  width: 120px;
  height: auto;
  animation: pulse 1.5s infinite;
  border-radius: 50%;
  box-shadow: 0 0 15px #06f;
}

/* fade-out state */
.loader.hidden {
  opacity: 0;
  visibility: hidden;
}

@keyframes pulse {
  0%   { transform: scale(1);   opacity: 0.8; }
  50%  { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1);   opacity: 0.8; }
}
.search-loader{
  position: fixed;
  display: flex;
  background: rgba(255 , 255, 255, 0.2);
  z-index: 10000;
  width: 99vw;
  justify-content: center;
  align-items: center;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: none;
}
@keyframes spin-bor{
  0%{ transform: rotateX(0);}
  25%{transform: rotateX(360deg);}
  50%{transform: rotateY(360deg);}
  100%{transform: rotateY(0) rotateX(360deg);}
}
    </style>
     <script>
     document.querySelector(".search-loader").style.display='flex';
  window.addEventListener("load", () => {
      
    const loader = document.querySelector(".loader");
    loader.classList.add("hidden")
    setTimeout(()=>document.querySelector(".search-loader").style.display='none', 1500);
  });
     </script>

    <script type="module" defer>
        
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const { url, key } = {url: "https://fgglquyepbbzrdzmkpfd.supabase.co", 
key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnZ2xxdXllcGJienJkem1rcGZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwOTkyMjksImV4cCI6MjA3NDY3NTIyOX0.mT03kocvd2gMLu6y4VeYXQqcBKUPD5DKtku6HrRO7cA"};


export const supabase = createClient(url, key);


async function getUser() {
  const { data, error } = await supabase.auth.getUser();
  if (error) {
    console.error("Auth error:", error);
    return null;
  }
  return data?.user || null;
}

async function signOut() {
  await supabase.auth.signOut();
  window.location.href = "/signup.html"; // redirect to login
}

// ========== DASHBOARD UI ==========
const sections = {
  user: document.getElementById("user-section"),
  pen: document.getElementById("pen-section"),
  sales: document.getElementById("sales-section"),
  chart: document.getElementById("chart-section"),
  posts: document.getElementById("posts-section")
};
let authBio = "creator";
let authImg  ="/assets/images/default.png";
let authName = "creator";
let authSkill  = "creator"; 

function showSection(name) {
  Object.values(sections).forEach(sec => sec.classList.add("hidden"));
  if (sections[name]) sections[name].classList.remove("hidden");
}

document.querySelector(".top-btn.user").onclick = () => showSection("user");
document.querySelector(".top-btn.pen").onclick = () => showSection("pen");
document.querySelector(".top-btn.sales").onclick = () => showSection("sales");
document.querySelector(".top-btn.chart").onclick = () => showSection("chart");

// ========== PROFILE ==========
async function loadProfile() {
  const user = await getUser();
  if (!user) {
    window.location.href = "/signup.html";
    return;
  }
  
  document.querySelector(".user .email").textContent = user.email;
  document.querySelector(".user  .uid").textContent = user.id;
  

  const { data: profile } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single();
  
  if (profile) {
    document.getElementById("userName").value = profile.username || "";
    document.getElementById("bio").value = profile.bio || "";
    document.getElementById("skill").value = profile.skills || "";
    document.querySelector(".user.img").src = profile.photo_url || "/assets/images/default.png";
    authBio = profile.bio ||"";
    authImg = profile.photo_url||"/assets/images/default.png";
    authName = profile.username || "";
    authSkill = profile.skills || "";
  }
}

document.querySelector(".user-btn.logout").onclick = signOut;

const zipInput = document.getElementById("zipInput");
const filename = document.querySelector(".file-name");

zipInput.onchange = () => {
  filename.textContent = zipInput.files[0]?.name || "";
};

document.getElementById("publisherForm").onsubmit = async (e) => {
  e.preventDefault();
  
  document.querySelector(".sending").style.display="inline-block";
  
  const user = await getUser();
  if (!user) return alert("Please log in.");
  
  const file = zipInput.files[0];
  if (!file) return alert("Select a ZIP file");
  
  // Upload to Supabase Storage
  const { data: storageData, error: storageError } = await supabase.storage
    .from("uploads")
    .upload(`${user.id}/${file.name}`, file, { upsert: true });
  
  if (storageError) {
    console.error(storageError);
    return alert("Upload failed.");
    document.querySelector(".sending").style.display="none";
  }
  
  // Insert metadata 
  const { error: dbError } = await supabase.from("posts").insert({
    user_id: user.id,
    name: document.getElementById("cardName").value.replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;"),
    description: document.getElementById("cardDes").value.replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;"),
    cover: document.getElementById("cardCover").value,
    viewer: document.getElementById("cardView").value,
    price: parseFloat(document.getElementById("cardAmount").value),
    file_path: storageData.path,
    star: 0,
    sales: 0,
    auth_bio: authBio, 
    auth_img: authImg, 
    auth_name: authName, 
    auth_skill: authSkill
  });
  
  if (dbError) {
    console.error(dbError);
    return sendAlert("Database insert failed.", "#d00");
    document.querySelector(".sending").style.display="none";
  }
  document.querySelector(".sending").style.display="none";
  loadPosts();
  sendAlert("Upload successful!");
  showSection("posts");
};

// ========== DELETE POST ==========
async function deletePost(post) {
  const confirmDelete = confirm(`Delete "${post.name}"? This cannot be undone.`);
  if (!confirmDelete) return;

  // Delete from storage
  if (post.file_path) {
    const { error: storageError } = await supabase.storage
      .from("uploads")
      .remove([post.file_path]);
    if (storageError) {
      console.error("Storage delete error:", storageError);
      sendAlert("Failed to delete file from storage.", '#d00');
      return;
    }
  }

  // Delete from database
  const { error: dbError } = await supabase
    .from("posts")
    .delete()
    .eq("id", post.id);

  if (dbError) {
    console.error("DB delete error:", dbError);
    alert("Failed to delete post from database.");
    return;
  }

  alert("Post deleted!");
  loadPosts();
}

// ========== SALES & POSTS ==========
// ========== SALES & POSTS ==========
async function loadPosts() {
  try {
    const user = await getUser();
    if (!user) {
      console.warn("No logged-in user found.");
      return;
    }
    
    console.log("Current user ID:", user.id);
    
    const { data, error } = await supabase
      .from("posts")
      .select("id, name, description, price, cover, auth_bio,  auth_img, auth_name, star, sales, auth_skill")
      .eq("user_id", user.id) 
      .order("id", { ascending: false }); // newest first
    
    if (error) {
      throw error;
    }
    
    const grid = document.querySelector(".product-grid");
    grid.innerHTML = "";
    
    if (!data || data.length === 0) {
      grid.innerHTML = `<p class="empty-msg">You haven’t uploaded any posts yet.</p>`;
      return;
    }
    
    data.forEach(post => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
      <div class="product-img" style="background-image: url(${post.cover || "/assets/images/index.png"});">
        <h3 class="delete-btn"><i class="fas fa-times"></i></h3>
        <a href="/home.html#search?q=${encodeURIComponent(post.description)}"><h4 data-view="${post.viewer || 'https://media.tenor.com/aGgnqxZUzeUAAAAM/sad.gif'}"><I class="fas fa-eye"></I></h4></a>
    </div>
    <p class="product-describe">
        <strong>${post.name.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong>
        <br>
        ${post.description.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
    </p>
        <div class="profile" data-bio="${post.auth_bio||''} • ${post.auth_skill||''}">
        <p><img src="${post.auth_img||post.cover||'/assets/images/default.png'}" alt="User_auth-profile">
        <strong class="user-name">@${post.auth_name?post.auth_name:post.name.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong></p>
    </div>
    <div class="buttons">
        <span class="star-contain"><span class="star-count">${post.star? post.star:0}</span></span> stars
    <span class="amount" data-price="${post.price||0}">$${post.price||0} <small><b class="sales">${post.sales? post.sales:0}</b> sales</small></span>
    <a href="/home.html#search?q=${encodeURIComponent(post.name)}"><span class="star-contain"><i class="fas fa-search"></i> </span></a>
    </div>
      `;
      
      //`
      
      
      div.querySelector(".delete-btn").onclick = () => deletePost(post);
      grid.appendChild(div);
    });
  } catch (error) {
    console.error("Error loading posts:", error);
  }
}

const profileForm = document.querySelector('form[name="user edit"]');

profileForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const username = profileForm.querySelector(".username").value.replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;").trim();
  const bio = profileForm.querySelector(".bio").value.replace(/&/g, "&amp;") 
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;").trim();
  const skill = profileForm.querySelector(".skill").value;
  const photoFile = profileForm.querySelector("#imgUrl").files[0];
  
  try {
    // 1. Get current logged-in user
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) throw new Error("Not logged in");
    
    let photoUrl = null;
    
    // 2. If new photo uploaded, push to storage
    if (photoFile) {
      const fileExt = photoFile.name.split('.').pop();
      const fileName = `avatars/${user.id}.${fileExt}`;
      
      const { error: uploadError } = await supabase.storage
        .from("avatars")
        .upload(fileName, photoFile, { upsert: true });
      
      if (uploadError) throw uploadError;
      
      const { data: publicUrl } = supabase.storage
        .from("avatars")
        .getPublicUrl(fileName);
      
      photoUrl = publicUrl.publicUrl;
    }
    
    // 3. Update profile table
    const { error: updateError } = await supabase
      .from("profiles")
      .update({
        username,
        bio,
        skills: skill,
        ...(photoUrl && { photo_url: photoUrl })
      })
      .eq("id", user.id);
    
    if (updateError) throw updateError;
    
    sendAlert("✅ Profile updated!");
    loadProfile();
  } catch (err) {
    console.error("Profile update error:", err.message);
    sendAlert("❌ Error updating profile: " + err.message, "#d00");
  }
});

async function loadSalesSummary() {
  const user = await getUser();
  if (!user) return;

  const { data, error } = await supabase
    .from("posts")
    .select("price, sales")
    .eq("user_id", user.id);

  if (error) {
    console.error("Sales summary error:", error);
    return;
  }

  if (!data || data.length === 0) {
    document.querySelector(".sales-stats").innerHTML = "<p>No sales yet.</p>";
    return;
  }

  let totalSales = 0;
  let unitsSold = 0;

  data.forEach(post => {
    totalSales += (post.price || 0) * (post.sales || 0);
    unitsSold += post.sales || 0;
  });

  document.querySelector(".sales-stats").innerHTML = `
    <div class="card">Total Sales: <strong>$${totalSales.toFixed(2)}</strong></div>
    <div class="card">Units Sold: <strong>${unitsSold}</strong></div>
    <div class="card">Products: <strong>${data.length}</strong></div>
    <div class="card">
    Available balance: 
    <strong>${await getAvailableBalance()}</strong></div>
  `;
}

async function loadSalesChart() {
  const user = await getUser();
  if (!user) return;

  const { data, error } = await supabase
    .from("posts")
    .select("name, sales, star")
    .eq("user_id", user.id);

  if (error) {
    console.error("Chart load error:", error);
    return;
  }

  const ctx = document.getElementById("salesChart").getContext("2d");
  if (window.myChart) window.myChart.destroy(); // destroy old chart if any

  window.myChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(p => p.name),
      datasets: [
        {
          label: "Sales",
          data: data.map(p => p.sales || 0),
          backgroundColor: "rgba(54, 162, 235, 0.6)"
        },
        {
          label: "Stars",
          data: data.map(p => p.star || 0),
          backgroundColor: "rgba(255, 206, 86, 0.6)"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "top" } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

async function renderPerformanceChart() {
  const user = await getUser();
  if (!user) return;

  const { data, error } = await supabase
    .from("posts")
    .select("name, sales, star")
    .eq("user_id", user.id);

  if (error) {
    console.error("Chart load error:", error);
    return;
  }

  // Prepare arrays
  const names = data.map(post => post.name);
  const sales = data.map(post => post.sales || 0);
  const stars = data.map(post => post.star || 0);

  const ctx = document.getElementById("salesChart").getContext("2d");
  if (window.performanceChart) window.performanceChart.destroy();

  window.performanceChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: names,
      datasets: [
        {
          label: "Sales",
          data: sales,
          backgroundColor: "rgba(54, 162, 235, 0.6)"
        },
        {
          label: "Stars",
          data: stars,
          backgroundColor: "rgba(255, 206, 86, 0.6)"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "top" } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

async function getAvailableBalance() {
  const user = await getUser();
  if (!user) return 0;

  // Total earnings from transactions
  const { data: txData, error: txError } = await supabase
    .from("transactions")
    .select("creator_earnings")
    .eq("user_id", user.id);

  if (txError) {
    console.error("Error loading transactions:", txError);
    return 0;
  }
  const totalEarnings = txData.reduce((sum, t) => sum + t.creator_earnings, 0);

  // Total already paid out
  const { data: withdraws, error: wdError } = await supabase
    .from("withdraw_requests")
    .select("amount, status")
    .eq("user_id", user.id)
    .in("status", ["approved", "paid"]); // only count approved/paid

  if (wdError) {
    console.error("Error loading withdraws:", wdError);
    return 0;
  }
  const totalWithdrawn = withdraws.reduce((sum, w) => sum + w.amount, 0);

  return totalEarnings - totalWithdrawn||0;
}

async function requestWithdraw(amount) {
  const user = await getUser();
  if (!user) return;
  
  const balance = await getAvailableBalance();
  if (amount > balance) {
    return alert(`❌ You can only withdraw up to $${balance.toFixed(2)}`);
  }
  
  const { error } = await supabase.from("withdraw_requests").insert({
    user_id: user.id,
    amount,
    status: "pending"
  });
  
  if (error) {
    console.error("Withdraw request failed:", error);
    return;
  }
  
  alert("✅ Withdraw request submitted for review!");
}

document.getElementById("withdrawForm").addEventListener("submit", async (e)=>{
  e.preventDefault()
  await requestWithdraw(document.querySelector("#requestAmt").value);
  
})
document.getElementById("delete-account").addEventListener("click", async () => {
  if (!confirm("⚠️ This will permanently delete your account and posts. Continue?")) {
    return;
  }

  const user = (await supabase.auth.getUser()).data.user;
  if (!user) {
    alert("No user logged in");
    return;
  }

  try {
    // 1. Delete posts (optional – remove if you want to keep them)
    const { error: postsError } = await supabase
      .from("posts")
      .delete()
      .eq("user_id", user.id);
    if (postsError) console.error("Post delete error:", postsError);

    // 2. Delete profile
    const { error: profileError } = await supabase
      .from("profiles")
      .delete()
      .eq("id", user.id);
    if (profileError) console.error("Profile delete error:", profileError);

    
    const resS = await fetch("/.netlify/functions/deleteUser", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid: user.id })
    });

    if (!resS.ok) throw new Error("Auth delete failed");

    alert("✅ Account deleted successfully.");
    window.location.href = "/"; // redirect to homepage
  } catch (err) {
    console.error("Delete error:", err.message);
    alert("❌ Error deleting account: " + err.message);
  }
});


// ========== INIT ==========

window.addEventListener("DOMContentLoaded", () => {
  loadProfile();
  loadPosts();
  loadSalesSummary();
  loadSalesChart();
  renderPerformanceChart();
});

    </script>
</body>
</html>
